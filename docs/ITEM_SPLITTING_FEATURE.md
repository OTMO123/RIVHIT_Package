# Функция автоматического разделения товаров по коробкам

## Обзор
Система автоматически разделяет товары на несколько строк, когда заказанное количество превышает максимальную вместимость коробки.

## Как это работает

### 1. Настройка максимальной вместимости
- Откройте настройки (кнопка ⚙️ в интерфейсе упаковки)
- Добавьте максимальную вместимость для каждого каталожного номера товара
- Данные сохраняются в SQLite базе данных

### 2. Автоматическое разделение при открытии заказа
Когда оператор открывает заказ для упаковки:

1. **Система проверяет каждый товар:**
   - Получает максимальную вместимость из БД по каталожному номеру
   - Сравнивает с заказанным количеством

2. **Если количество превышает максимум:**
   - Целочисленное деление: `полные_коробки = количество / макс_вместимость`
   - Остаток: `остаток = количество % макс_вместимость`
   
3. **Создание строк в таблице:**
   - Для каждой полной коробки создается отдельная строка с максимальным количеством
   - Если есть остаток, создается дополнительная строка с частичным количеством
   - Каждая строка помечается как "Коробка X/Y"

## Пример

**Заказано:** 50 единиц товара "MILK001"  
**Макс. вместимость:** 12 единиц на коробку

**Результат разделения:**
- Строка 1: 12 единиц - "Коробка 1/5"
- Строка 2: 12 единиц - "Коробка 2/5"
- Строка 3: 12 единиц - "Коробка 3/5"
- Строка 4: 12 единиц - "Коробка 4/5"
- Строка 5: 2 единицы - "Коробка 5/5 (Частичная)"

## UI индикация

### В таблице упаковки:
- Разделенные товары показываются с синим тегом "Коробка X/Y"
- Под описанием товара показывается "Из N единиц всего"
- Каждая строка имеет уникальный ID для системы соединений

### Визуальные соединения:
- Можно соединять разделенные товары между собой
- Система автоматически перенумерует коробки после соединения

## Техническая реализация

### Backend (SQLite):
```typescript
// Таблица max_per_box_settings
{
  id: number;
  catalog_number: string;  // Уникальный каталожный номер
  max_quantity: number;    // Максимальная вместимость
  description?: string;    // Описание товара
  rivhit_id?: number;      // ID в системе RIVHIT
  is_active: boolean;      // Активность настройки
  created_at: Date;
  updated_at: Date;
}
```

### Frontend логика:
```typescript
// Функция разделения товаров
const splitItemsByMaxCapacity = async (items: any[]): Promise<any[]> => {
  for (const item of items) {
    const maxCapacity = await apiService.getMaxPerBoxByCatalog(item.catalog_number);
    
    if (maxCapacity && item.quantity > maxCapacity) {
      const fullBoxes = Math.floor(item.quantity / maxCapacity);
      const remainder = item.quantity % maxCapacity;
      
      // Создание строк для полных коробок
      for (let i = 0; i < fullBoxes; i++) {
        createSplitRow(item, maxCapacity, i + 1, fullBoxes + (remainder > 0 ? 1 : 0));
      }
      
      // Создание строки для остатка
      if (remainder > 0) {
        createRemainderRow(item, remainder, fullBoxes + 1);
      }
    }
  }
};
```

## API endpoints

### Получение настроек:
- `GET /api/settings/max-per-box` - все настройки
- `GET /api/settings/max-per-box/catalog/:catalogNumber` - по каталожному номеру

### Управление настройками:
- `POST /api/settings/max-per-box` - создание/обновление
- `PUT /api/settings/max-per-box/:id` - обновление
- `DELETE /api/settings/max-per-box/:id` - удаление

## Преимущества

1. **Автоматизация:** Не нужно вручную разделять большие заказы
2. **Точность:** Исключены ошибки при подсчете коробок
3. **Скорость:** Мгновенное разделение при открытии заказа
4. **Гибкость:** Можно объединять разделенные товары через визуальные соединения
5. **Прозрачность:** Оператор видит, из какого общего количества взята каждая коробка

## Настройка для нового товара

1. Откройте модальное окно настроек (кнопка ⚙️)
2. Нажмите "Add New Setting"
3. Введите:
   - Catalog Number (из RIVHIT)
   - Max Quantity per Box
   - Description (опционально)
4. Сохраните настройку

Теперь при заказе этого товара в количестве, превышающем максимум, система автоматически разделит его на несколько коробок.